{% extends "base.html" %}
{% block content %}
<h1>選擇會議時間區間</h1>
<p>請點選可參加的時間區段（視覺化表示），然後提交。</p>
<hr>

<form method="post" id="time-slot-form">
  {% csrf_token %}
  <input type="hidden" name="pick_time_slots" value="1">
  
  <!-- Hidden checkboxes -->
  <div id="checkboxes" style="display: none;">
    {{ form.time_slots }}
  </div>

  <!-- Timeline visualization -->
  <div id="timeline-container" class="my-4" style="position: relative; width: 100%; height: 60px; background: #f5f5f5; border: 1px solid #ccc; border-radius: 5px;">
    <!-- Colored blocks will be inserted here by JS -->
  </div>

  <div class="text-center mt-3">
    <button class="btn btn-success" type="submit">確定並排程</button>
  </div>
</form>

<script>
document.addEventListener("DOMContentLoaded", function () {
  // Parse the checkbox labels to extract time intervals
  const timelineContainer = document.getElementById("timeline-container");
  const checkboxes = document.querySelectorAll("#checkboxes input[type='checkbox']");
  const labels = document.querySelectorAll("#checkboxes label");

  // Extract time ranges from labels (e.g., "09:00-10:00")
  const timeRanges = [];
  checkboxes.forEach((checkbox, i) => {
    const label = labels[i];
    const timeText = label.textContent.trim();
    const match = timeText.match(/(\d{2}:\d{2})\s*~\s*(\d{2}:\d{2})/);
    if (match) {
      timeRanges.push({
        checkbox,
        label,
        start: match[1],
        end: match[2]
      });
    }
  });

  function timeToMinutes(t) {
    const [h, m] = t.split(":").map(Number);
    return h * 60 + m;
  }

  // Find the earliest and latest times
  const allStarts = timeRanges.map(r => timeToMinutes(r.start));
  const allEnds = timeRanges.map(r => timeToMinutes(r.end));
  const minTime = Math.min(...allStarts);
  const maxTime = Math.max(...allEnds);
  const totalDuration = maxTime - minTime;

  // Create blocks on the timeline
  timeRanges.forEach((range, i) => {
    const startMin = timeToMinutes(range.start) - minTime;
    const endMin = timeToMinutes(range.end) - minTime;
    const leftPercent = (startMin / totalDuration) * 100;
    const widthPercent = ((endMin - startMin) / totalDuration) * 100;

    const block = document.createElement("div");
    block.style.position = "absolute";
    block.style.left = `${leftPercent}%`;
    block.style.width = `${widthPercent}%`;
    block.style.height = "100%";
    block.style.background = "#ddd";
    block.style.border = "1px solid #aaa";
    block.style.cursor = "pointer";
    block.style.transition = "background 0.3s";
    block.title = range.start + " - " + range.end;

    // Sync checkbox state
    function updateColor() {
      block.style.background = range.checkbox.checked ? "#4caf50" : "#ddd";
    }

    block.addEventListener("click", () => {
      range.checkbox.checked = !range.checkbox.checked;
      updateColor();
    });

    updateColor();
    timelineContainer.appendChild(block);
  });
});
console.log("Checkboxes:", checkboxes);
console.log("Labels:", labels);
labels.forEach((label, i) => {
  console.log(`Label ${i}:`, label.textContent);
});
</script>

<style>
/* Optional: responsive label styling */
#timeline-container {
  min-width: 100%;
  max-width: 100%;
  overflow-x: auto;
}
</style>
{% endblock %}